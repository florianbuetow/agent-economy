# Default recipe: show available commands
_default:
    @just help

# Show help information
help:
    @clear
    @echo ""
    @printf "\033[0;34m=== Base Agent ===\033[0m\n"
    @echo ""
    @printf "\033[1;33mSetup\033[0m\n"
    @printf "  \033[0;37mjust init             \033[0;34m Initialize development environment\033[0m\n"
    @printf "  \033[0;37mjust destroy          \033[0;34m Remove virtual environment\033[0m\n"
    @echo ""
    @printf "\033[1;33mCode Quality\033[0m\n"
    @printf "  \033[0;37mjust code-format      \033[0;34m Auto-fix formatting\033[0m\n"
    @printf "  \033[0;37mjust code-style       \033[0;34m Check style (read-only)\033[0m\n"
    @printf "  \033[0;37mjust code-typecheck   \033[0;34m Run mypy\033[0m\n"
    @printf "  \033[0;37mjust code-security    \033[0;34m Run bandit\033[0m\n"
    @printf "  \033[0;37mjust code-spell       \033[0;34m Check spelling\033[0m\n"
    @echo ""
    @printf "\033[1;33mTesting\033[0m\n"
    @printf "  \033[0;37mjust test             \033[0;34m Run all tests\033[0m\n"
    @printf "  \033[0;37mjust test-unit        \033[0;34m Run unit tests only\033[0m\n"
    @printf "  \033[0;37mjust test-e2e   \033[0;34m Run e2e tests only\033[0m\n"
    @echo ""
    @printf "\033[1;33mCI\033[0m\n"
    @printf "  \033[0;37mjust ci               \033[0;34m Run all CI checks (verbose)\033[0m\n"
    @printf "  \033[0;37mjust ci-quiet         \033[0;34m Run all CI checks (quiet)\033[0m\n"
    @echo ""

# Initialize the development environment
init:
    @echo ""
    @printf "\033[0;34m=== Initializing Base Agent Environment ===\033[0m\n"
    @echo "Installing Python dependencies..."
    @uv sync --all-extras
    @printf "\033[0;32m✓ Base agent environment ready\033[0m\n"
    @echo ""

# Destroy the virtual environment
destroy:
    @echo ""
    @printf "\033[0;34m=== Destroying Virtual Environment ===\033[0m\n"
    @rm -rf .venv
    @printf "\033[0;32m✓ Virtual environment removed\033[0m\n"
    @echo ""

# Auto-fix formatting
code-format:
    @echo ""
    uv run ruff format src/ tests/
    uv run ruff check --fix src/ tests/
    @printf "\033[0;32m✓ Formatting applied\033[0m\n"
    @echo ""

# Check style (read-only)
code-style:
    @echo ""
    uv run ruff format --check src/ tests/
    uv run ruff check src/ tests/
    @printf "\033[0;32m✓ Style checks passed\033[0m\n"
    @echo ""

# Run mypy
code-typecheck:
    @echo ""
    uv run mypy src/
    @printf "\033[0;32m✓ Type checks passed\033[0m\n"
    @echo ""

# Run bandit
code-security:
    @echo ""
    uv run bandit -r src/ -c pyproject.toml
    @printf "\033[0;32m✓ Security checks passed\033[0m\n"
    @echo ""

# Check spelling
code-spell:
    @echo ""
    uv run codespell src/ tests/ --ignore-words-list="assertIn"
    @printf "\033[0;32m✓ Spelling checks passed\033[0m\n"
    @echo ""

# Run all tests
test:
    @echo ""
    uv run pytest tests/ -v -m "not e2e"
    @printf "\033[0;32m✓ All tests passed\033[0m\n"
    @echo ""

# Run unit tests only
test-unit:
    @echo ""
    uv run pytest tests/unit/ -v -m unit
    @printf "\033[0;32m✓ Unit tests passed\033[0m\n"
    @echo ""

# Run e2e tests only
test-e2e:
    @echo ""
    uv run pytest tests/e2e/ -v -m e2e
    @printf "\033[0;32m✓ E2E tests passed\033[0m\n"
    @echo ""

# Run all CI checks (verbose)
ci:
    #!/usr/bin/env bash
    set -euo pipefail
    printf "\n"
    printf "\033[0;34m=== Running CI for Base Agent ===\033[0m\n"
    printf "\n"

    printf "\033[0;34m--- Formatting ---\033[0m\n"
    uv run ruff format --check src/ tests/

    printf "\033[0;34m--- Linting ---\033[0m\n"
    uv run ruff check src/ tests/

    printf "\033[0;34m--- Type Checking (mypy) ---\033[0m\n"
    uv run mypy src/

    printf "\033[0;34m--- Security (bandit) ---\033[0m\n"
    uv run bandit -r src/ -c pyproject.toml

    printf "\033[0;34m--- Spelling ---\033[0m\n"
    uv run codespell src/ tests/ --ignore-words-list="assertIn"

    printf "\033[0;34m--- Tests ---\033[0m\n"
    uv run pytest tests/ -v -m "not e2e"

    printf "\n"
    printf "\033[0;32m✓ All CI checks passed\033[0m\n"
    printf "\n"

# Run all CI checks (quiet)
ci-quiet:
    #!/usr/bin/env bash
    set -euo pipefail
    printf "Checking base-agent...\n"

    uv run ruff format --check src/ tests/ > /dev/null 2>&1
    uv run ruff check src/ tests/ > /dev/null 2>&1
    uv run mypy src/ > /dev/null 2>&1
    uv run bandit -r src/ -c pyproject.toml -q > /dev/null 2>&1
    uv run codespell src/ tests/ --ignore-words-list="assertIn" > /dev/null 2>&1
    uv run pytest tests/ -v --tb=short -m "not e2e"

    printf "\033[0;32m✓ base-agent CI passed\033[0m\n"
